<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Secret Santa Draw</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#0f172a; --card:#111827; --muted:#94a3b8; --text:#e5e7eb; --accent:#22d3ee; }
    html,body{height:100%}
    body{
      margin:0; display:grid; place-items:center; background:radial-gradient(1200px 1200px at 10% 10%, #111827 0%, #0b1020 60%, #050814 100%);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      color:var(--text);
    }
    .card{
      width:min(600px, 92vw); background:linear-gradient(180deg, #0b1224 0%, #0a0f1e 100%);
      border:1px solid #1f2937; border-radius:20px; padding:24px; box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    h1{margin:0 0 8px; font-size:clamp(22px, 3.4vw, 30px)}
    p.small{margin:.25rem 0 1rem; color:var(--muted); font-size:14px}
    .row{display:flex; gap:10px; align-items:center; margin:.6rem 0}
    select, button, a.btn{
      font-size:16px; border-radius:12px; border:1px solid #263142; background:#0f1628; color:var(--text);
      padding:12px 14px; outline:none; transition: transform .04s ease, border-color .2s;
    }
    select{flex:1}
    button:hover, a.btn:hover{border-color:#31425c}
    button:active, a.btn:active{transform:scale(0.99)}
    .primary{background:linear-gradient(180deg, #0b3a49, #0a2f3b); border-color:#144a58}
    .accent{background:linear-gradient(180deg, #08313a, #082833); border-color:#135b67}
    .danger{background:linear-gradient(180deg, #3a0b0b, #2b0a0a); border-color:#612626}
    .result{
      margin-top:14px; padding:18px; border:1px dashed #2b3b52; border-radius:16px; background:#0b1222; display:none;
    }
    .result.show{display:block}
    .name{font-size:22px; font-weight:700}
    .muted{color:var(--muted)}
    .pill{display:inline-block; padding:6px 10px; border:1px solid #263142; border-radius:999px; font-size:12px; color:var(--muted)}
    .spacer{flex:1}
    .footer{display:flex; gap:8px; margin-top:12px; flex-wrap:wrap}
    .linky{color:var(--accent); text-decoration:none; border-bottom:1px dashed rgba(34,211,238,.35); padding-bottom:1px}
    .linky:hover{border-bottom-color:rgba(34,211,238,.7)}
  </style>
</head>
<body>
  <div class="card" role="application" aria-label="Secret Santa draw tool">
    <h1>Secret Santa Draw</h1>
    <p class="small">Pick your name, then click the button. It‚Äôll reveal your person (nobody gets themselves). Assignments are generated once and stored locally for this session.</p>

    <div class="row">
      <label for="who" class="muted" style="min-width:74px">I am</label>
      <select id="who" aria-label="Your name"></select>
      <a href="#" id="draw" class="btn primary" role="button" aria-label="Reveal my assignment">Reveal üéÅ</a>
    </div>

    <div class="row" style="margin-top:.2rem">
      <span id="status" class="pill" title="How many results remain to be revealed">Remaining: ‚Äî</span>
      <div class="spacer"></div>
      <button id="hide" class="accent" title="Hide the last revealed name">Hide</button>
      <button id="reset" class="danger" title="Reset all assignments">Reset</button>
    </div>

    <div id="result" class="result" aria-live="polite">
      <div class="muted">You are shopping for</div>
      <div id="recipient" class="name" style="margin-top:6px">‚Äî</div>
      <div class="muted" id="tip" style="margin-top:8px"></div>
    </div>

    <p class="small" style="margin-top:16px">P.S. If this looks too ‚Äútrust me bro,‚Äù we can add a passcode or export the final mapping. For now it's designed for an in-person draw on one device.</p>
    <p class="small">Historical vibe: in 1913 the U.S. <span class="linky" tabindex="0" role="note">Parcel Post</span> launched and folks started mailing all sorts of wild ‚Äúgifts.‚Äù Compared to that chaos, this app is downright organized üòÖ.</p>
  </div>

  <script>
    // ====== 1) EDIT THESE NAMES ======
    const PARTICIPANTS = [
      "Alice",
      "Bob",
      "Charlie",
      "Danielle",
      "Erin",
      "Frank"
    ];
    // Optional: add "exclusions" (e.g., spouses). Format: { "Alice": ["Bob"], "Bob": ["Alice"] }
    const EXCLUSIONS = {
      // "Alice": ["Bob"], "Bob": ["Alice"]
    };
    // =================================

    const KEY = "ssanta:v1";
    const state = loadStateOrInit();
    const whoSel = document.getElementById("who");
    const drawBtn = document.getElementById("draw");
    const resultBox = document.getElementById("result");
    const recipientEl = document.getElementById("recipient");
    const tipEl = document.getElementById("tip");
    const statusPill = document.getElementById("status");
    const hideBtn = document.getElementById("hide");
    const resetBtn = document.getElementById("reset");

    populateNameSelect();
    updateStatus();

    drawBtn.addEventListener("click", (e) => {
      e.preventDefault();
      const me = whoSel.value;
      if (!me) return alert("Pick your name first.");
      const got = state.mapping[me];
      if (!got) return alert("No assignment found for that name. Try Reset.");
      showResult(got, me);
      if (!state.revealed[me]) {
        state.revealed[me] = true;
        saveState();
        updateStatus();
      }
    });

    hideBtn.addEventListener("click", () => {
      resultBox.classList.remove("show");
    });

    resetBtn.addEventListener("click", () => {
      const code = Math.random().toString(36).slice(2, 8).toUpperCase();
      const answer = prompt(`Type this code to confirm reset: ${code}`);
      if (answer && answer.toUpperCase() === code) {
        sessionStorage.removeItem(KEY);
        location.reload();
      }
    });

    function showResult(recipient, me) {
      recipientEl.textContent = recipient;
      const hint = craftHint(me, recipient);
      tipEl.textContent = hint;
      resultBox.classList.add("show");
    }

    function populateNameSelect() {
      whoSel.innerHTML = `<option value="">‚Äî choose your name ‚Äî</option>` +
        state.names.map(n => `<option>${escapeHtml(n)}</option>`).join("");
    }

    function updateStatus() {
      const total = state.names.length;
      const revealed = Object.values(state.revealed).filter(Boolean).length;
      statusPill.textContent = `Remaining: ${total - revealed} of ${total}`;
    }

    function loadStateOrInit() {
      const saved = sessionStorage.getItem(KEY);
      if (saved) {
        try {
          const parsed = JSON.parse(saved);
          // If participant list changed, regenerate fresh
          if (!arrayEqualIgnoreOrder(parsed.names, PARTICIPANTS)) {
            return initState();
          }
          return parsed;
        } catch { /* fallthrough */ }
      }
      return initState();
    }

    function initState() {
      const names = [...PARTICIPANTS];
      const mapping = makeAssignments(names, EXCLUSIONS);
      const revealed = Object.fromEntries(names.map(n => [n, false]));
      const obj = { names, mapping, revealed, createdAt: Date.now() };
      sessionStorage.setItem(KEY, JSON.stringify(obj));
      return obj;
    }

    function saveState() {
      sessionStorage.setItem(KEY, JSON.stringify(state));
    }

    // Generate a derangement (no one gets themselves) while also honoring EXCLUSIONS.
    function makeAssignments(names, exclusions) {
      // Try multiple times to satisfy constraints
      for (let attempt = 0; attempt < 500; attempt++) {
        const shuffled = shuffle([...names]);
        // Fix self-matches by swapping as needed
        for (let i = 0; i < names.length; i++) {
          if (shuffled[i] === names[i]) {
            const j = (i === names.length - 1) ? 0 : i + 1;
            [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
          }
        }
        // Validate exclusions
        let ok = true;
        for (let i = 0; i < names.length; i++) {
          const giver = names[i];
          const recv = shuffled[i];
          const banned = new Set([giver, ...(exclusions[giver] || [])]);
          if (banned.has(recv)) { ok = false; break; }
        }
        if (ok) {
          // If exclusions accidentally broke by swaps, try again
          const map = {};
          for (let i = 0; i < names.length; i++) map[names[i]] = shuffled[i];
          // Final pass: fix any exclusion collisions by pairwise swaps if possible
          if (fixExclusions(map, names, exclusions)) return map;
        }
      }
      throw new Error("Could not build assignments with given exclusions. Try different pairs.");
    }

    function fixExclusions(map, names, exclusions) {
      // Simple greedy repair: for any banned pair, try swap with someone else
      const isBanned = (giver, recv) => {
        const banned = new Set([giver, ...(exclusions[giver] || [])]);
        return banned.has(recv);
      };
      for (let i = 0; i < names.length; i++) {
        const a = names[i];
        const ra = map[a];
        if (isBanned(a, ra)) {
          // find b to swap recipients with
          let swapped = false;
          for (let j = 0; j < names.length; j++) {
            if (i === j) continue;
            const b = names[j];
            const rb = map[b];
            if (!isBanned(a, rb) && !isBanned(b, ra) && a !== rb && b !== ra) {
              map[a] = rb; map[b] = ra; swapped = true; break;
            }
          }
          if (!swapped) return false;
        }
      }
      // Re-check self-matches (shouldn't exist)
      return names.every(n => map[n] !== n);
    }

    function shuffle(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    function escapeHtml(s){ return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[c])); }
    function arrayEqualIgnoreOrder(a,b){
      if (a.length !== b.length) return false;
      const sa = [...a].sort(), sb = [...b].sort();
      return sa.every((v,i)=>v===sb[i]);
    }
    function craftHint(me, rec){
      const cheeky = [
        "No peeking over shoulders.",
        "Shop smart, not loud.",
        "Budget‚Äôs a social construct‚Ä¶ but still, be nice.",
        "Gift card? Only if it‚Äôs creative.",
        "Wrap game strong, tape game stronger."
      ];
      return `${me}, keep it secret. Keep it safe. ${cheeky[Math.floor(Math.random()*cheeky.length)]}`;
    }
  </script>
</body>
</html>
