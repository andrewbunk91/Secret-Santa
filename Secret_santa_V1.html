<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Secret Santa Draw</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#0f172a; --card:#111827; --muted:#94a3b8; --text:#e5e7eb; --accent:#22d3ee; }
    html,body{height:100%}
    body{
      margin:0; display:grid; place-items:center; background:radial-gradient(1200px 1200px at 10% 10%, #111827 0%, #0b1020 60%, #050814 100%);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      color:var(--text);
    }
    .card{
      width:min(600px, 92vw); background:linear-gradient(180deg, #0b1224 0%, #0a0f1e 100%);
      border:1px solid #1f2937; border-radius:20px; padding:24px; box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    h1{margin:0 0 8px; font-size:clamp(22px, 3.4vw, 30px)}
    p.small{margin:.25rem 0 1rem; color:var(--muted); font-size:14px}
    .row{display:flex; gap:10px; align-items:center; margin:.6rem 0}
    select, button{
      font-size:16px; border-radius:12px; border:1px solid #263142; background:#0f1628; color:var(--text);
      padding:12px 14px; outline:none; transition: transform .04s ease, border-color .2s;
    }
    select{flex:1}
    button:hover{border-color:#31425c}
    button:active{transform:scale(0.99)}
    .primary{background:linear-gradient(180deg, #0b3a49, #0a2f3b); border-color:#144a58}
    .accent{background:linear-gradient(180deg, #08313a, #082833); border-color:#135b67}
    .danger{background:linear-gradient(180deg, #3a0b0b, #2b0a0a); border-color:#612626}
    button.is-loading{opacity:.6; cursor:wait; pointer-events:none}
    select:disabled, button:disabled{opacity:.6; cursor:not-allowed}
    select option[disabled]{color:#64748b}
    .result{
      margin-top:14px; padding:18px; border:1px dashed #2b3b52; border-radius:16px; background:#0b1222; display:none;
    }
    .result.show{display:block}
    .name{font-size:22px; font-weight:700}
    .muted{color:var(--muted)}
    .pill{display:inline-block; padding:6px 10px; border:1px solid #263142; border-radius:999px; font-size:12px; color:var(--muted)}
    .spacer{flex:1}
    .footer{display:flex; gap:8px; margin-top:12px; flex-wrap:wrap}
    .linky{color:var(--accent); text-decoration:none; border-bottom:1px dashed rgba(34,211,238,.35); padding-bottom:1px}
    .linky:hover{border-bottom-color:rgba(34,211,238,.7)}
  </style>
</head>
<body>
  <div class="card" role="application" aria-label="Secret Santa draw tool">
    <h1>Secret Santa Draw</h1>
    <p class="small">Pick your name, then click reveal. Assignments live on the server so once someone draws, that giver and recipient are locked in‚Äîeven if the app restarts.</p>

    <div class="row">
      <label for="who" class="muted" style="min-width:74px">I am</label>
      <select id="who" aria-label="Your name"></select>
      <button id="draw" class="primary" type="button" aria-label="Reveal my assignment">Reveal üéÅ</button>
    </div>

    <div class="row" style="margin-top:.2rem">
      <span id="status" class="pill" title="How many results remain to be revealed">Remaining: ‚Äî</span>
      <div class="spacer"></div>
      <button id="hide" class="accent" title="Hide the last revealed name">Hide</button>
      <button id="reset" class="danger" title="Reset all assignments">Reset</button>
    </div>

    <div id="result" class="result" aria-live="polite">
      <div class="muted">You are shopping for</div>
      <div id="recipient" class="name" style="margin-top:6px">‚Äî</div>
      <div class="muted" id="tip" style="margin-top:8px"></div>
    </div>

    <p class="small" style="margin-top:16px">P.S. If this looks too ‚Äútrust me bro,‚Äù we can add a passcode or export the final mapping. For now it's designed for an in-person draw on one device.</p>
    <p class="small">Historical vibe: in 1913 the U.S. <span class="linky" tabindex="0" role="note">Parcel Post</span> launched and folks started mailing all sorts of wild ‚Äúgifts.‚Äù Compared to that chaos, this app is downright organized üòÖ.</p>
  </div>

  <script>
    const whoSel = document.getElementById("who");
    const drawBtn = document.getElementById("draw");
    const resultBox = document.getElementById("result");
    const recipientEl = document.getElementById("recipient");
    const tipEl = document.getElementById("tip");
    const statusPill = document.getElementById("status");
    const hideBtn = document.getElementById("hide");
    const resetBtn = document.getElementById("reset");

    const uiState = {
      participants: [],
      revealed: {},
      remaining: 0,
      total: 0,
      takenRecipients: []
    };

    let serverAvailable = false;

    toggleControls(false);
    refreshState();

    drawBtn.addEventListener("click", onDraw);
    hideBtn.addEventListener("click", () => {
      resultBox.classList.remove("show");
    });
    resetBtn.addEventListener("click", onReset);

    async function refreshState() {
      try {
        const res = await fetch("/api/state", { cache: "no-store" });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        uiState.participants = Array.isArray(data.participants) ? data.participants : [];
        uiState.revealed = data.revealed || {};
        uiState.remaining = typeof data.remaining === "number" ? data.remaining : 0;
        uiState.total = typeof data.total === "number" ? data.total : uiState.participants.length;
        uiState.takenRecipients = Array.isArray(data.takenRecipients) ? data.takenRecipients : [];
        populateNameSelect();
        updateStatus();
        toggleControls(true);
      } catch (err) {
        console.error("Failed to load state", err);
        statusPill.textContent = "Server unavailable";
        statusPill.title = "Unable to reach the Secret Santa server";
        toggleControls(false);
      }
    }

    function populateNameSelect() {
      const frag = document.createDocumentFragment();
      const placeholder = document.createElement("option");
      placeholder.value = "";
      placeholder.textContent = "‚Äî choose your name ‚Äî";
      frag.appendChild(placeholder);

      uiState.participants.forEach((name) => {
        const opt = document.createElement("option");
        opt.value = name;
        if (uiState.revealed[name]) {
          opt.disabled = true;
          opt.textContent = `${name} (already drawn)`;
        } else {
          opt.textContent = name;
        }
        frag.appendChild(opt);
      });

      whoSel.innerHTML = "";
      whoSel.appendChild(frag);
      whoSel.value = "";
    }

    function updateStatus() {
      statusPill.textContent = `Remaining: ${uiState.remaining} of ${uiState.total}`;
      if (uiState.takenRecipients.length) {
        statusPill.title = `${uiState.remaining} participants still need to draw. Already assigned: ${uiState.takenRecipients.join(", ")}`;
      } else {
        statusPill.title = `${uiState.remaining} participants still need to draw`;
      }
    }

    function toggleControls(enabled) {
      serverAvailable = enabled;
      if (enabled) {
        whoSel.removeAttribute("disabled");
        resetBtn.removeAttribute("disabled");
        if (!drawBtn.classList.contains("is-loading")) {
          if (uiState.remaining > 0) {
            drawBtn.removeAttribute("disabled");
          } else {
            drawBtn.setAttribute("disabled", "disabled");
          }
        }
      } else {
        whoSel.setAttribute("disabled", "disabled");
        resetBtn.setAttribute("disabled", "disabled");
        drawBtn.setAttribute("disabled", "disabled");
      }
    }

    async function onDraw(event) {
      event.preventDefault();
      const me = whoSel.value.trim();
      if (!me) {
        alert("Pick your name first.");
        return;
      }
      if (uiState.revealed[me]) {
        alert("That name already drew a recipient.");
        await refreshState();
        return;
      }
      setLoading(drawBtn, true);
      try {
        const res = await fetch("/api/draw", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ giver: me })
        });
        if (!res.ok) {
          const err = await safeJson(res);
          const msg = err && err.error ? err.error : `Unable to draw (HTTP ${res.status})`;
          alert(msg);
          return;
        }
        const data = await res.json();
        showResult(data.recipient, me);
        await refreshState();
      } catch (err) {
        console.error("Draw failed", err);
        alert("Unable to reach the server. Please try again.");
      } finally {
        setLoading(drawBtn, false);
        whoSel.value = "";
      }
    }

    async function onReset() {
      const code = Math.random().toString(36).slice(2, 8).toUpperCase();
      const answer = prompt(`Type this code to confirm reset: ${code}`);
      if (!answer || answer.toUpperCase() !== code) return;
      setLoading(resetBtn, true);
      try {
        const res = await fetch("/api/reset", { method: "POST" });
        if (!res.ok) {
          const err = await safeJson(res);
          const msg = err && err.error ? err.error : `Reset failed (HTTP ${res.status})`;
          alert(msg);
          return;
        }
        await refreshState();
        resultBox.classList.remove("show");
      } catch (err) {
        console.error("Reset failed", err);
        alert("Unable to reset right now. Try again in a moment.");
      } finally {
        setLoading(resetBtn, false);
      }
    }

    function showResult(recipient, me) {
      recipientEl.textContent = recipient;
      tipEl.textContent = craftHint(me, recipient);
      resultBox.classList.add("show");
    }

    function setLoading(el, loading) {
      if (loading) {
        el.classList.add("is-loading");
        el.setAttribute("disabled", "disabled");
      } else {
        el.classList.remove("is-loading");
        if (el === drawBtn) {
          if (serverAvailable && uiState.remaining > 0) {
            el.removeAttribute("disabled");
          } else {
            el.setAttribute("disabled", "disabled");
          }
        } else if (el === resetBtn) {
          if (serverAvailable) {
            el.removeAttribute("disabled");
          } else {
            el.setAttribute("disabled", "disabled");
          }
        } else {
          el.removeAttribute("disabled");
        }
      }
    }

    async function safeJson(res) {
      try {
        return await res.json();
      } catch {
        return null;
      }
    }

    function craftHint(me, rec) {
      const cheeky = [
        "No peeking over shoulders.",
        "Shop smart, not loud.",
        "Budget‚Äôs a social construct‚Ä¶ but still, be nice.",
        "Gift card? Only if it‚Äôs creative.",
        "Wrap game strong, tape game stronger."
      ];
      return `${me}, keep it secret. Keep it safe. ${cheeky[Math.floor(Math.random() * cheeky.length)]}`;
    }
  </script>
</body>
</html>
