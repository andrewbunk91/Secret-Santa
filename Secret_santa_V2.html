<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Secret Santa Draw</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* ======= Base + palette ======= */
    :root{
      --bg:#0f172a; --card:#111827; --muted:#94a3b8; --text:#e5e7eb; --accent:#22d3ee;
      --edge:#1f2937; --holly:#e11d48; --pine:#22c55e; --gold:#f6c453;
      --stripe-start: 60vh; /* default; JS will set the exact value */
    }
    html,body{height:100%}
    body{
      position:relative;
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      color:var(--text);
      background: radial-gradient(1200px 800px at 10% 0%, #0e1730 0%, #0b1220 60%, #070c18 100%);
      overflow-x:hidden;
    }

    /* ======= Festive hero with animated Santa + snow ======= */
    .hero{
      position:relative; overflow:hidden;
      padding:54px 20px 90px;
      background:
        linear-gradient(180deg, rgba(18,29,58,.65), rgba(11,18,32,.0) 70%),
        radial-gradient(900px 300px at 50% -20%, rgba(255,255,255,.08), rgba(0,0,0,0));
      border-bottom:1px solid var(--edge);
      z-index:2;
    }
    .hero-inner{max-width:900px; margin:0 auto; text-align:center; position:relative; z-index:3}
    .title{font-size:clamp(26px,4.6vw,44px); margin:0 0 8px; letter-spacing:.4px}
    .subtitle{margin:0; color:var(--muted); font-size:clamp(14px,2.2vw,16px)}
    .santa-flight{
      position:absolute; left:-52vw; top:32px; width:min(52vw,540px);
      opacity:.95; animation: fly 19s linear infinite; pointer-events:none; z-index:2;
    }
    .santa{
      display:block; width:100%;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,.35)); pointer-events:none;
    }
    @keyframes fly{
      0%{ transform: translateX(-10vw) translateY(0) scale(1); opacity:0 }
      12%{ opacity:.95 }
      50%{ transform: translateX(72vw) translateY(-10px) scale(1.04) }
      100%{ transform: translateX(118vw) translateY(0) scale(1); opacity:0 }
    }
    .snow{
      position:absolute; inset:0; pointer-events:none; overflow:hidden; z-index:1;
    }
    .snow-layer{
      position:absolute;
      top:-160%;
      left:-80%;
      width:240%;
      height:320%;
      pointer-events:none;
      background-image:
        radial-gradient(2.2px 2.2px at 20px 20px, rgba(255,255,255,.88), rgba(255,255,255,0)),
        radial-gradient(1.8px 1.8px at 120px 80px, rgba(255,255,255,.82), rgba(255,255,255,0)),
        radial-gradient(2.4px 2.4px at 220px 140px, rgba(255,255,255,.9), rgba(255,255,255,0)),
        radial-gradient(1.6px 1.6px at 320px 40px, rgba(255,255,255,.78), rgba(255,255,255,0)),
        radial-gradient(1.8px 1.8px at 420px 210px, rgba(255,255,255,.86), rgba(255,255,255,0)),
        radial-gradient(2px 2px at 540px 120px, rgba(255,255,255,.9), rgba(255,255,255,0)),
        radial-gradient(1.4px 1.4px at 640px 260px, rgba(255,255,255,.74), rgba(255,255,255,0)),
        radial-gradient(1.8px 1.8px at 720px 60px, rgba(255,255,255,.85), rgba(255,255,255,0)),
        radial-gradient(2.2px 2.2px at 820px 200px, rgba(255,255,255,.9), rgba(255,255,255,0));
      background-size:360px 360px;
      background-repeat:repeat;
      animation: snowfall 36s linear infinite;
      will-change: transform;
    }
    .snow-layer--far{
      opacity:.3;
      filter: blur(1.5px);
      animation-duration:54s;
      animation-delay:-18s;
    }
    .snow-layer--mid{
      opacity:.55;
      filter: blur(.9px);
      animation-duration:32s;
      animation-delay:-9s;
    }
    .snow-layer--near{
      opacity:.9;
      filter: blur(.4px);
      animation-duration:18s;
      animation-direction:reverse;
    }
    @keyframes snowfall{
      0%{ transform: translate3d(0,-12%,0); }
      100%{ transform: translate3d(-22%,108%,0); }
    }
    @media (prefers-reduced-motion: reduce){
      .santa-flight,
      .snow-layer{
        animation-duration:0.01ms !important;
        animation-iteration-count:1 !important;
        animation-name:none !important;
      }
    }

    /* ======= Candy-cane stripes starting exactly at hero bottom ======= */
    body::after{
      content:"";
      position:fixed;
      left:0; right:0;
      top: var(--stripe-start);
      bottom:0;
      background:
        repeating-linear-gradient(45deg,
          #b91c1c 0 16px,   /* red band */
          #ffffff 16px 32px /* white band */
        );
      opacity:.15;
      z-index:1;
      pointer-events:none;
    }
    .wrap{ z-index:3; position:relative; }

    /* ======= Content area ======= */
    .wrap{max-width:900px; margin:-48px auto 48px; padding:0 16px}
    .card{
      width:auto; max-width:900px; background:linear-gradient(180deg, rgba(16,24,40,.82), rgba(10,16,28,.92));
      border:1px solid var(--edge); border-radius:20px; padding:24px; box-shadow: 0 20px 60px rgba(0,0,0,.35);
      backdrop-filter: blur(6px);
    }
    h1{margin:0 0 8px; font-size:clamp(22px, 3.4vw, 30px)}
    p.small{margin:.25rem 0 1rem; color:var(--muted); font-size:14px}
    .row{display:flex; gap:10px; align-items:center; margin:.6rem 0; flex-wrap:wrap}
    select, button{
      font-size:16px; border-radius:12px; border:1px solid #2b395b; background:#0f1628; color:var(--text);
      padding:12px 14px; outline:none; transition: transform .04s ease, border-color .2s;
    }
    select{flex:1}
    button:hover{border-color:#31425c}
    button:active{transform:scale(0.99)}
    .primary{background:linear-gradient(180deg, #7f1d1d, #4c0519); border-color:#7f1d1d; font-weight:600}
    .accent{background:linear-gradient(180deg, #0a3921, #082f1b); border-color:#14532d}
    .danger{background:linear-gradient(180deg, #3a0b0b, #2b0a0a); border-color:#612626}
    button.is-loading{opacity:.6; cursor:wait; pointer-events:none}
    select:disabled, button:disabled{opacity:.6; cursor:not-allowed}
    select option[disabled]{color:#64748b}
    .result{
      margin-top:14px; padding:18px; border:1px dashed #33426a; border-radius:16px; background:#0b1324; display:none;
    }
    .result.show{display:block}
    .name{font-size:22px; font-weight:800; color:var(--gold)}
    .muted{color:var(--muted)}
    .pill{display:inline-block; padding:6px 10px; border:1px solid #2b395b; border-radius:999px; font-size:12px; color:var(--muted)}
    .spacer{flex:1}
  </style>
</head>
<body>

  <!-- üéÑ Festive header -->
  <header class="hero">
    <div class="snow" aria-hidden="true">
      <div class="snow-layer snow-layer--far"></div>
      <div class="snow-layer snow-layer--mid"></div>
      <div class="snow-layer snow-layer--near"></div>
    </div>
    <div class="santa-flight" aria-hidden="true">
      <img class="santa" src="./assets/Santas-Sleigh-And-Reindeer-Silhouette.svg" alt="Santa and his reindeer flying" loading="eager">
    </div>
    <div class="hero-inner">
      <h1 class="title">Secret Santa üéÑ</h1>
      <p class="subtitle">pick your name ‚Ä¢ keep it secret ‚Ä¢ spread some cheer</p>
    </div>
  </header>

  <!-- Main card -->
  <div class="wrap">
    <div class="card" role="application" aria-label="Secret Santa draw tool">
      <h1>Secret Santa Draw</h1>
      <p class="small">Pick your name, then click reveal. If something happened call me and ill reset it, do not reset it yourself please unless you want your device to blow up -love Andy.</p>

      <div class="row">
        <label for="who" class="muted" style="min-width:74px">I am</label>
        <select id="who" aria-label="Your name"></select>
        <button id="draw" class="primary" type="button" aria-label="Reveal my assignment">Reveal üéÅ</button>
      </div>

      <div class="row" style="margin-top:.2rem">
        <span id="status" class="pill" title="How many results remain to be revealed">Remaining: ‚Äî</span>
        <div class="spacer"></div>
        <button id="hide" class="accent" title="Hide the last revealed name">Hide</button>
        <button id="reset" class="danger" title="Reset all assignments">Reset</button>
        <button id="musicBtn" class="accent" title="Toggle Christmas music">üé∂ Music</button>
      </div>

      <div id="result" class="result" aria-live="polite">
        <div class="muted">You are shopping for</div>
        <div id="recipient" class="name" style="margin-top:6px">‚Äî</div>
        <div class="muted" id="tip" style="margin-top:8px"></div>
      </div>
    </div>
  </div>

  <!-- Background soundtrack (put before scripts so JS can find it) -->
  <audio id="bgmusic" loop>
    <source src="jinglebells.mp3" type="audio/mpeg">
    Your browser does not support the audio element.
  </audio>

  <!-- ======= App logic + jingle ======= -->
  <script>
    const whoSel = document.getElementById("who");
    const drawBtn = document.getElementById("draw");
    const resultBox = document.getElementById("result");
    const recipientEl = document.getElementById("recipient");
    const tipEl = document.getElementById("tip");
    const statusPill = document.getElementById("status");
    const hideBtn = document.getElementById("hide");
    const resetBtn = document.getElementById("reset");

    // Ensure the sleigh art renders even if the external file cannot be fetched
    const santaImg = document.querySelector('.santa-flight img.santa');
    if (santaImg) {
      const santaSrc = santaImg.getAttribute('src');
      if (santaSrc && santaSrc.startsWith('assets/')) {
        santaImg.src = `./${santaSrc}`;
      }
      const inlineSantaSvg = `
        <svg viewBox="0 0 760 200" xmlns="http://www.w3.org/2000/svg" focusable="false" aria-hidden="true">
          <title>Santa's sleigh and reindeer silhouette</title>
          <desc>A festive silhouette of Santa riding a sleigh pulled by three reindeer.</desc>
          <g fill="#f8fafc">
            <path d="M206 82l7-12 320 114-7 12z"/>
            <path d="M56 140c0-22 16-40 44-48l28-8v-26l-18 6c-24 8-38 22-38 36 0 6 2 12 4 18H54c-4-8-6-16-6-26 0-26 20-46 54-56l46-12c-6-12-8-22-8-34 0-28 20-50 52-50 22 0 40 10 50 30l10 20 58-12c24-4 40 10 40 34 0 32-26 58-70 70l-88 22c14 20 40 32 66 32 26 0 48-10 68-28l18 16c-24 24-56 36-88 36-40 0-74-18-94-50l-36 8c-18 4-26 16-26 30 0 6 2 12 4 18H32c-4-8-6-18-6-28 0-28 20-52 54-60l34-8V96l-22 8c-16 6-32 18-32 36z"/>
            <circle cx="228" cy="46" r="16"/>
            <path d="M214 34l34-10 10 20-32 12z"/>
            <path d="M224 90c32-6 68-8 102-6l-2 18-100 8z"/>
            <g transform="translate(318 44) scale(0.95)">
              <path d="M8 74c4-18 18-30 38-30h30l10-18 12 6-10 16h18c16 0 28 8 30 20 2 12-6 22-20 28l-18 6 18 8c10 6 14 12 12 22-4 12-18 20-34 20-16 0-30-6-40-16l-8 16H28l12-24-20-6 6-12 18 6 8-18-18-2c-14-2-24-10-26-20z"/>
              <path d="M86 18l16-18 10 8-14 18 18-4 6 10-24 6z"/>
            </g>
            <g transform="translate(456 36) scale(1.02)">
              <path d="M8 74c4-18 18-30 38-30h30l10-18 12 6-10 16h18c16 0 28 8 30 20 2 12-6 22-20 28l-18 6 18 8c10 6 14 12 12 22-4 12-18 20-34 20-16 0-30-6-40-16l-8 16H28l12-24-20-6 6-12 18 6 8-18-18-2c-14-2-24-10-26-20z"/>
              <path d="M86 18l16-18 10 8-14 18 18-4 6 10-24 6z"/>
            </g>
            <g transform="translate(594 30) scale(1.08)">
              <path d="M8 74c4-18 18-30 38-30h30l10-18 12 6-10 16h18c16 0 28 8 30 20 2 12-6 22-20 28l-18 6 18 8c10 6 14 12 12 22-4 12-18 20-34 20-16 0-30-6-40-16l-8 16H28l12-24-20-6 6-12 18 6 8-18-18-2c-14-2-24-10-26-20z"/>
              <path d="M86 18l16-18 10 8-14 18 18-4 6 10-24 6z"/>
            </g>
          </g>
        </svg>
      `;
      santaImg.addEventListener('error', () => {
        const tpl = document.createElement('template');
        tpl.innerHTML = inlineSantaSvg.trim();
        const svgEl = tpl.content.firstElementChild;
        svgEl.classList.add('santa');
        svgEl.setAttribute('aria-hidden', 'true');
        svgEl.setAttribute('focusable', 'false');
        santaImg.replaceWith(svgEl);
      }, { once: true });
    }

    // Music elements
    let bgmusic = document.getElementById("bgmusic");
    let musicBtn = document.getElementById("musicBtn");
    let musicPlaying = false;

    const uiState = {
      participants: [],
      revealed: {},
      remaining: 0,
      total: 0,
      takenRecipients: []
    };

    // === Music toggle (safe) ===
    if (musicBtn && bgmusic) {
      musicBtn.addEventListener("click", () => {
        if (!musicPlaying) {
          bgmusic.play().then(() => {
            musicBtn.textContent = "‚è∏Ô∏è Pause";
            musicPlaying = true;
          }).catch(err => console.log("Autoplay blocked:", err));
        } else {
          bgmusic.pause();
          musicBtn.textContent = "üé∂ Music";
          musicPlaying = false;
        }
      });
    }

    /* ===== WebAudio jingle (no file needed) ===== */
    let audioCtx;
    function playJingle(){
      try{
        if(!audioCtx){
          audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }
        const now = audioCtx.currentTime;
        const notes = [523.25, 659.25, 783.99, 1046.5]; // C5 E5 G5 C6
        notes.forEach((f, i) => tone(f, now + i*0.12, 0.16));
      }catch(e){ /* ignore if blocked */ }
    }
    function tone(freq, start, dur){
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = "triangle";
      o.frequency.value = freq;
      g.gain.setValueAtTime(0.0001, start);
      g.gain.exponentialRampToValueAtTime(0.22, start + 0.02);
      g.gain.exponentialRampToValueAtTime(0.0001, start + dur);
      o.connect(g); g.connect(audioCtx.destination);
      o.start(start); o.stop(start + dur + 0.02);
    }

    let serverAvailable = false;

    toggleControls(false);
    refreshState();

    drawBtn.addEventListener("click", onDraw);
    hideBtn.addEventListener("click", () => {
      resultBox.classList.remove("show");
    });
    resetBtn.addEventListener("click", onReset);

    async function refreshState() {
      try {
        const res = await fetch("/api/state", { cache: "no-store" });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        uiState.participants = Array.isArray(data.participants) ? data.participants : [];
        uiState.revealed = data.revealed || {};
        uiState.remaining = typeof data.remaining === "number" ? data.remaining : 0;
        uiState.total = typeof data.total === "number" ? data.total : uiState.participants.length;
        uiState.takenRecipients = Array.isArray(data.takenRecipients) ? data.takenRecipients : [];
        populateNameSelect();
        updateStatus();
        toggleControls(true);
      } catch (err) {
        console.error("Failed to load state", err);
        statusPill.textContent = "Server unavailable";
        statusPill.title = "Unable to reach the Secret Santa server";
        toggleControls(false);
      }
    }

    function populateNameSelect() {
      const frag = document.createDocumentFragment();
      const placeholder = document.createElement("option");
      placeholder.value = "";
      placeholder.textContent = "‚Äî choose your name ‚Äî";
      frag.appendChild(placeholder);

      uiState.participants.forEach((name) => {
        const opt = document.createElement("option");
        opt.value = name;
        if (uiState.revealed[name]) {
          opt.disabled = true;
          opt.textContent = `${name} (already drawn)`;
        } else {
          opt.textContent = name;
        }
        frag.appendChild(opt);
      });

      whoSel.innerHTML = "";
      whoSel.appendChild(frag);
      whoSel.value = "";
    }

    function updateStatus() {
      statusPill.textContent = `Remaining: ${uiState.remaining} of ${uiState.total}`;
      if (uiState.takenRecipients.length) {
        statusPill.title = `${uiState.remaining} participants still need to draw. Already assigned: ${uiState.takenRecipients.join(", ")}`;
      } else {
        statusPill.title = `${uiState.remaining} participants still need to draw`;
      }
    }

    function toggleControls(enabled) {
      serverAvailable = enabled;
      if (enabled) {
        whoSel.removeAttribute("disabled");
        resetBtn.removeAttribute("disabled");
        if (!drawBtn.classList.contains("is-loading")) {
          if (uiState.remaining > 0) {
            drawBtn.removeAttribute("disabled");
          } else {
            drawBtn.setAttribute("disabled", "disabled");
          }
        }
      } else {
        whoSel.setAttribute("disabled", "disabled");
        resetBtn.setAttribute("disabled", "disabled");
        drawBtn.setAttribute("disabled", "disabled");
      }
    }

    async function onDraw(event) {
      event.preventDefault();
      const me = whoSel.value.trim();
      if (!me) {
        alert("Pick your name first.");
        return;
      }
      if (uiState.revealed[me]) {
        alert("That name already drew a recipient.");
        await refreshState();
        return;
      }
      setLoading(drawBtn, true);
      try {
        const res = await fetch("/api/draw", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ giver: me })
        });
        if (!res.ok) {
          const err = await safeJson(res);
          const msg = err && err.error ? err.error : `Unable to draw (HTTP ${res.status})`;
          alert(msg);
          return;
        }
        const data = await res.json();
        showResult(data.recipient, me);
        playJingle(); // üîî jingle on reveal

        // Optional: kick off music after first reveal (counts as a user gesture)
        if (!musicPlaying && bgmusic) {
          bgmusic.play().then(()=>{
            if (musicBtn) musicBtn.textContent = "‚è∏Ô∏è Pause";
            musicPlaying = true;
          }).catch(()=>{});
        }

        await refreshState();
      } catch (err) {
        console.error("Draw failed", err);
        alert("Unable to reach the server. Please try again.");
      } finally {
        setLoading(drawBtn, false);
        whoSel.value = "";
      }
    }

    async function onReset() {
      const code = Math.random().toString(36).slice(2, 8).toUpperCase();
      const answer = prompt(`Type this code to confirm reset: ${code}`);
      if (!answer || answer.toUpperCase() !== code) return;
      setLoading(resetBtn, true);
      try {
        const res = await fetch("/api/reset", { method: "POST" });
        if (!res.ok) {
          const err = await safeJson(res);
          const msg = err && err.error ? err.error : `Reset failed (HTTP ${res.status})`;
          alert(msg);
          return;
        }
        await refreshState();
        resultBox.classList.remove("show");
      } catch (err) {
        console.error("Reset failed", err);
        alert("Unable to reset right now. Try again in a moment.");
      } finally {
        setLoading(resetBtn, false);
      }
    }

    function showResult(recipient, me) {
      recipientEl.textContent = recipient;
      tipEl.textContent = craftHint(me, recipient);
      resultBox.classList.add("show");
    }

    function setLoading(el, loading) {
      if (loading) {
        el.classList.add("is-loading");
        el.setAttribute("disabled", "disabled");
      } else {
        el.classList.remove("is-loading");
        if (el === drawBtn) {
          if (serverAvailable && uiState.remaining > 0) {
            el.removeAttribute("disabled");
          } else {
            el.setAttribute("disabled", "disabled");
          }
        } else if (el === resetBtn) {
          if (serverAvailable) {
            el.removeAttribute("disabled");
          } else {
            el.setAttribute("disabled", "disabled");
          }
        } else {
          el.removeAttribute("disabled");
        }
      }
    }

    async function safeJson(res) {
      try { return await res.json(); } catch { return null; }
    }

    function craftHint(me, rec) {
      const cheeky = [
        "No peeking over shoulders.",
        "Shop smart, not loud.",
        "Budget‚Äôs a social construct‚Ä¶ but still, be nice.",
        "Gift card? Only if it‚Äôs creative.",
        "Wrap game strong, tape game stronger."
      ];
      return `${me}, keep it secret. Keep it safe. ${cheeky[Math.floor(Math.random()*cheeky.length)]}`;
    }

    function autoStartMusicOnce() {
      if (!bgmusic || musicPlaying) return;
      bgmusic.play().then(() => {
        if (musicBtn) musicBtn.textContent = "‚è∏Ô∏è Pause";
        musicPlaying = true;
        removeAutoStarters();
      }).catch(() => {
          // still blocked? they'll need to press the Music button
        removeAutoStarters();
      });
    }
    function removeAutoStarters() {
      window.removeEventListener('pointerdown', autoStartMusicOnce);
      window.removeEventListener('keydown', autoStartMusicOnce);
      window.removeEventListener('touchstart', autoStartMusicOnce);
    }
        // attach once, so ANY interaction starts it
    window.addEventListener('pointerdown', autoStartMusicOnce, { once: true });
    window.addEventListener('keydown', autoStartMusicOnce, { once: true });
    window.addEventListener('touchstart', autoStartMusicOnce, { once: true });

          // (optional) try on load; most browsers will block, but no harm
    window.addEventListener('load', () => {
      if (!musicPlaying && bgmusic) bgmusic.play().catch(()=>{});
    });


  </script>

  <!-- ======= set stripe start exactly at hero bottom ======= -->
  <script>
    function setStripeStart(){
      const hero = document.querySelector('.hero');
      if(!hero) return;
      const bottom = hero.getBoundingClientRect().bottom + window.scrollY;
      document.documentElement.style.setProperty('--stripe-start', bottom + 'px');
    }
    window.addEventListener('load', setStripeStart);
    window.addEventListener('resize', setStripeStart);
  </script>

</body>
</html>
